<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pacman Game</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;500;600&display=swap');

      body {
        background-color: black;
        overflow: hidden;
        font-family: "Pixelify Sans", sans-serif;
        font-size: 10px;
        color: white;
      }

      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin: 10% 0;
      }

      canvas {
        background-color: black;
      }

      #modal {
        display: none;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        position: absolute;
        background-color: rgba(0, 0, 0, 0.75);
        font-size: 2.8rem;
        text-align: center;
        flex-direction: column;
      }

      table {
        font-size: 2rem;
        text-align: center;
        margin-bottom: 2rem;
      }

      th, td {
        padding: 0 1rem;
      }

      #restart-btn {
        font-family: "Pixelify Sans", sans-serif;
        font-size: 1.8rem;
        background-color: black;
        color: yellow;
        padding: 1rem;
        border-radius: 5px;
        border-style: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <table>
        <thead>
          <th>Lives</th>
          <th>Score</th>
        </thead>
        <tr>
          <td id="lives"></td>
          <td id="score"></td>
        </tr>
      </table>
      <canvas id="pacmanCanvas"></canvas>
      <div id="modal">
        Game Over
        <span id="finalScore">Your score is </span>
        <button id="restart-btn">Play Again</button>
      </div>
    </div>
    <script>
      const canvas = document.getElementById("pacmanCanvas");
      const ctx = canvas.getContext("2d");
      const livesCell = document.getElementById("lives");
      const scoreCell = document.getElementById("score");
      const finalScore = document.getElementById("finalScore");
      const gameOverScreen = document.getElementById("modal");
      const restartButton = document.getElementById("restart-btn");

      canvas.width = 450;
      canvas.height = 450;
      const cellSize = 40;
      const foodSize = cellSize / 10;
      const specialSize = foodSize * 2;
      
      const gameSpeedDelay = 300;
      let lives = 3;
      let score = 0;
      let foodCount = 0;
      const foodPts = 1;
      const specialPts = 10;

      // 1 - wall, 2 - food, 3 - special
      const wallMap = [
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1],
        [1, 2, 1, 1, 1, 2, 1, 2, 1, 2, 1],
        [1, 2, 2, 2, 1, 2, 1, 2, 2, 2, 1],
        [1, 2, 1, 2, 2, 2, 3, 2, 1, 2, 1],
        [1, 2, 1, 1, 2, 1, 2, 1, 1, 2, 1],
        [1, 2, 1, 2, 3, 2, 2, 2, 1, 2, 1],
        [1, 2, 2, 2, 1, 2, 1, 2, 2, 2, 1],
        [1, 2, 1, 2, 1, 2, 1, 1, 1, 2, 1],
        [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      ];

      // Small map for testing
      const testMap = [
        [1, 1, 1, 1, 1, 1, 1],
        [1, 2, 2, 2, 2, 2, 1],
        [1, 2, 1, 1, 1, 2, 1],
        [1, 2, 1, 3, 1, 2, 1],
        [1, 2, 1, 2, 1, 2, 1],
        [1, 2, 2, 2, 2, 2, 1],
        [1, 1, 1, 1, 1, 1, 1],
      ];

      const ghostMap = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      ];

      class Pacman {
        constructor(x,y,direction, lives){
          this.x = x;
          this.y = y;
          this.direction = direction;
          this.lives = lives;
        }

        // TODO - Clean up the code 
        checkCollision() {
          switch(wallMap[pacman.y][pacman.x]){
            case 2:
              score += foodPts;
              foodCount--;
              wallMap[pacman.y][pacman.x] = 0;
              break;
            case 3:
              score += specialPts;
              foodCount--;
              wallMap[pacman.y][pacman.x] = 0;
              break;
          }
        }
      };

      const pacman = new Pacman(1, 1, "right", lives);

      function drawPacman() {
        ctx.beginPath();
        const centerX = (pacman.x + 0.5) * cellSize;
        const centerY = (pacman.y + 0.5) * cellSize;
        const radius = cellSize / 2 - 3;

        // Adjust the angles based on the direction
        let startAngle, endAngle;
        switch (pacman.direction) {
          case "right":
            startAngle = 0.2 * Math.PI;
            endAngle = 1.8 * Math.PI;
            break;
          case "down":
            startAngle = 0.7 * Math.PI;
            endAngle = 0.3 * Math.PI;
            break;
          case "left":
            startAngle = 1.2 * Math.PI;
            endAngle = 0.8 * Math.PI;
            break;
          case "up":
            startAngle = 1.7 * Math.PI;
            endAngle = 1.3 * Math.PI;
            break;
        }

        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = "yellow";
        ctx.fill();
        ctx.closePath();
      }

      function drawMap() {
        for (let y = 0; y < wallMap.length; y++) {
          for (let x = 0; x < wallMap[y].length; x++) {
            // Draw wall
            if (wallMap[y][x] === 1) {
              ctx.strokeStyle = "blue";
              ctx.lineJoin = "bevel";
              ctx.lineWidth = 1.2;
              ctx.strokeRect(x * cellSize, y * cellSize, cellSize, cellSize);
            }
            // Draw food
            else if (wallMap[y][x] === 2) {
              ctx.fillStyle = "white";
              ctx.fillRect(
                x * cellSize + cellSize / 2 - foodSize / 4,
                y * cellSize + cellSize / 2 - foodSize / 4,
                foodSize,
                foodSize
              );
            }
            // Draw special food
            else if (wallMap[y][x] === 3) {
              ctx.fillStyle = "orange";
              ctx.fillRect(
                x * cellSize + cellSize / 2 - specialSize / 4,
                y * cellSize + cellSize / 2 - specialSize / 4,
                specialSize,
                specialSize
              );
            }
          }
        }
      }

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      function update() {
        clearCanvas();
        drawMap();
        drawPacman();
        pacman.checkCollision();
        scoreCell.innerText = score;
        livesCell.innerText = lives;
      }

      function movePacman() {
        switch (pacman.direction) {
          case "up":
            if (pacman.y > 0 && wallMap[pacman.y - 1][pacman.x] != 1) {
              pacman.y--;
            }
            break;
          case "down":
            if (
              pacman.y < wallMap.length - 1 &&
              wallMap[pacman.y + 1][pacman.x] != 1
            ) {
              pacman.y++;
            }
            break;
          case "left":
            if (pacman.x > 0 && wallMap[pacman.y][pacman.x - 1] != 1) {
              pacman.x--;
            }
            break;
          case "right":
            if (
              pacman.x < wallMap[0].length - 1 &&
              wallMap[pacman.y][pacman.x + 1] != 1
            ) {
              pacman.x++;
            }
            break;
        }
      }

      document.addEventListener("keydown", function (event) {
        switch (event.key) {
          case "ArrowUp":
            pacman.direction = "up";
            break;
          case "ArrowDown":
            pacman.direction = "down";
            break;
          case "ArrowLeft":
            pacman.direction = "left";
            break;
          case "ArrowRight":
            pacman.direction = "right";
            break;
        }
      });

      function calcFoodCount() {
        for (let i = 0; i < wallMap.length; i++) {
          for (let j = 0; j < wallMap[i].length; j++) {
            if (wallMap[i][j] == 2 || wallMap[i][j] == 3) {
              foodCount++;
            }
          }
        }
      }

      function gameOverCheck(loop) {
        if(foodCount <= 0){
          clearTimeout(loop);
          gameOverScreen.style.display = "flex";
          finalScore.innerText += ` ${score}`;
        }
      }

      function restartGame() {
        location.reload();
      }

      restartButton.addEventListener("click", () => {
        restartGame();
      });
      
      let timeout;
      function gameLoop() {
        timeout = setTimeout(gameLoop, gameSpeedDelay); // Add a delay between frames
        movePacman();
        update();
        gameOverCheck(timeout);
      }

      calcFoodCount();

      gameLoop();
    </script>
  </body>
</html>